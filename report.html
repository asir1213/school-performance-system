<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø°ÙƒÙŠØ© | Ù†Ø¸Ø§Ù… ØªÙ‚ÙŠÙŠÙ… Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body{
  margin:0;
  font-family:Tahoma, Arial;
  background:#f4f6f9;
}

header{
  background:#1f3c88;
  color:#fff;
  padding:20px 30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header h2{margin:0}

.container{
  padding:30px;
}

.back{
  background:#eee;
  color:#333;
  padding:8px 14px;
  border-radius:6px;
  text-decoration:none;
}

.summary{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin-bottom:40px;
}

.box{
  background:#fff;
  padding:25px;
  border-radius:16px;
  text-align:center;
  box-shadow:0 10px 20px rgba(0,0,0,.08);
}

.box h4{
  margin:0;
  color:#555;
}

.box span{
  font-size:34px;
  color:#1f3c88;
  font-weight:bold;
}

.actions{
  margin-bottom:30px;
}

.actions button{
  background:#1f3c88;
  color:#fff;
  padding:10px 18px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  margin-left:10px;
  font-size:14px;
}

.actions button:hover{
  opacity:.9;
}

.charts{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(350px,1fr));
  gap:30px;
}

.card{
  background:#fff;
  padding:20px;
  border-radius:16px;
  box-shadow:0 10px 20px rgba(0,0,0,.08);
}

.card h3{
  text-align:center;
  color:#1f3c88;
  margin-top:0;
}
</style>
</head>

<body>

<header>
  <h2>ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø°ÙƒÙŠØ©</h2>
  <a href="dashboard.html" class="back">â¬… Ø±Ø¬ÙˆØ¹</a>
</header>

<div class="container">

  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ± -->
  <div class="actions">
    <button onclick="exportExcel()">â¬‡ï¸ ØªØµØ¯ÙŠØ± Excel</button>
    <button onclick="exportPDF()">â¬‡ï¸ ØªØµØ¯ÙŠØ± PDF</button>
  </div>

  <!-- Ø§Ù„Ù…Ù„Ø®Øµ -->
  <div class="summary">
    <div class="box">
      <h4>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¯Ù„Ø©</h4>
      <span id="total">0</span>
    </div>
    <div class="box">
      <h4>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆØ±</h4>
      <span id="axesCount">0</span>
    </div>
    <div class="box">
      <h4>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª</h4>
      <span id="domainsCount">0</span>
    </div>
    <div class="box">
      <h4>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±</h4>
      <span id="standardsCount">0</span>
    </div>
  </div>

  <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
  <div class="charts">

    <div class="card">
      <h3>Ø§Ù„Ø£Ø¯Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­ÙˆØ±</h3>
      <canvas id="axisChart"></canvas>
    </div>

    <div class="card">
      <h3>Ø§Ù„Ø£Ø¯Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù„</h3>
      <canvas id="domainChart"></canvas>
    </div>

    <div class="card">
      <h3>Ø§Ù„Ø£Ø¯Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹ÙŠØ§Ø±</h3>
      <canvas id="standardChart"></canvas>
    </div>

  </div>

</div>

<script>
// Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
if(!localStorage.getItem("loggedIn")){
  window.location.href="login.html";
}

// Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¯Ù„Ø©
const evidences = JSON.parse(localStorage.getItem("evidences")) || [];

// Ù…Ù„Ø®Øµ
document.getElementById("total").innerText = evidences.length;

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø¯
function countBy(key){
  const map = {};
  evidences.forEach(e=>{
    const value = e[key] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    map[value] = (map[value] || 0) + 1;
  });
  return map;
}

const axisData = countBy("axis");
const domainData = countBy("domain");
const standardData = countBy("standard");

document.getElementById("axesCount").innerText = Object.keys(axisData).length;
document.getElementById("domainsCount").innerText = Object.keys(domainData).length;
document.getElementById("standardsCount").innerText = Object.keys(standardData).length;

// Ø§Ù„Ø±Ø³ÙˆÙ…
new Chart(axisChart,{
  type:'bar',
  data:{
    labels:Object.keys(axisData),
    datasets:[{
      label:"Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¯Ù„Ø©",
      data:Object.values(axisData),
      backgroundColor:'#1f3c88'
    }]
  }
});

new Chart(domainChart,{
  type:'doughnut',
  data:{
    labels:Object.keys(domainData),
    datasets:[{
      data:Object.values(domainData),
      backgroundColor:['#1f3c88','#2563eb','#60a5fa','#93c5fd','#bfdbfe']
    }]
  }
});

new Chart(standardChart,{
  type:'bar',
  data:{
    labels:Object.keys(standardData),
    datasets:[{
      label:"Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¯Ù„Ø©",
      data:Object.values(standardData),
      backgroundColor:'#2563eb'
    }]
  }
});

/* ====== Ø§Ù„ØªØµØ¯ÙŠØ± ====== */

// Excel
function exportExcel(){
  if(evidences.length===0){
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±");
    return;
  }

  const data = evidences.map(e=>({
    "Ø§Ù„Ù…Ø­ÙˆØ±": e.axis,
    "Ø§Ù„Ù…Ø¬Ø§Ù„": e.domain,
    "Ø§Ù„Ù…Ø¹ÙŠØ§Ø±": e.standard,
    "Ø§Ù„Ø­Ø§Ù„Ø©": e.status || "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
    "Ù…Ù„Ø§Ø­Ø¸Ø§Øª": e.note || ""
  }));

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø£Ø¯Ù„Ø©");
  XLSX.writeFile(wb, "ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø£Ø¯Ù„Ø©.xlsx");
}

// PDF
function exportPDF(){
  if(evidences.length===0){
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("l","mm","a4");

  doc.text("ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ù„Ø©", 140, 10, {align:"center"});

  const rows = evidences.map(e=>[
    e.axis,
    e.domain,
    e.standard,
    e.status || "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
    e.note || ""
  ]);

  doc.autoTable({
    head:[["Ø§Ù„Ù…Ø­ÙˆØ±","Ø§Ù„Ù…Ø¬Ø§Ù„","Ø§Ù„Ù…Ø¹ÙŠØ§Ø±","Ø§Ù„Ø­Ø§Ù„Ø©","Ù…Ù„Ø§Ø­Ø¸Ø§Øª"]],
    body:rows,
    startY:20
  });

  doc.save("ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø£Ø¯Ù„Ø©.pdf");
}
</script>

</body>
</html>
